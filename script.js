// Generated by CoffeeScript 1.9.2
(function() {
  var KEYCODES, top;

  window.Editor = React.createClass({
    getInitialState: function() {
      var text;
      text = "hello world";
      return {
        text: text,
        cursor: text.length,
        selection_end: null,
        overlays: [
          {
            attribute: 'bold',
            start: 0,
            end: 3
          }, {
            attribute: 'italic',
            start: 6,
            end: 11
          }
        ]
      };
    },
    attributeToTag: function(attribute) {
      var simple_elements;
      simple_elements = {
        bold: 'b',
        italic: 'i',
        container: 'div',
        cursor: 'cursor'
      };
      return simple_elements[attribute];
    },
    renderTree: function(node) {
      var tag;
      if (node.text != null) {
        return React.createElement('span', {
          'data-start-index': node.start_index,
          'data-end-index': node.end_index
        }, node.text);
      }
      tag = this.attributeToTag(node.attribute);
      return React.createElement(tag, {
        'data-start-index': node.start_index,
        'data-end-index': node.end_index
      }, this.renderTreeList(node.children));
    },
    renderTreeList: function(nodes) {
      var i, len, node, results;
      results = [];
      for (i = 0, len = nodes.length; i < len; i++) {
        node = nodes[i];
        results.push(this.renderTree(node));
      }
      return results;
    },
    getAnchorIndex: function(anchor, offset) {
      if (anchor.nodeType === anchor.TEXT_NODE) {
        return (parseInt(anchor.parentNode.attributes['data-start-index'].value)) + offset;
      } else {
        return console.log("TODO: handle non-text clicks");
      }
    },
    onClick: function(event) {
      var cursor, index1, index2, selection, selection_end;
      selection = window.getSelection();
      if (selection.isCollapsed) {
        cursor = this.getAnchorIndex(selection.anchorNode, selection.anchorOffset);
        selection_end = null;
      } else {
        index1 = this.getAnchorIndex(selection.anchorNode, selection.anchorOffset);
        index2 = this.getAnchorIndex(selection.focusNode, selection.focusOffset);
        if (index1 < index2) {
          cursor = index1;
          selection_end = index2;
        } else {
          cursor = index2;
          selection_end = index1;
        }
      }
      console.log("set selection", cursor, selection_end);
      return this.setState({
        cursor: cursor,
        selection_end: selection_end
      });
    },
    onKeypress: function(event) {
      var character;
      event.preventDefault();
      character = String.fromCharCode(event.which);
      return console.log("insert character", character, this.state.cursor, this.state.selection_end);
    },
    onKeyDown: function(event) {
      var selection_end;
      if (event.keyCode === KEYCODES.backspace) {
        event.preventDefault();
        return console.log('backspace', this.state.cursor, this.state.selection_end);
      } else if (event.keyCode === KEYCODES.left) {
        if (event.shiftKey) {
          if (!this.state.selection_end) {
            this.setState({
              selection_end: this.state.cursor
            });
          }
          if (this.state.cursor > 0) {
            return this.setState({
              cursor: this.state.cursor - 1
            });
          }
        } else {
          if (this.state.selection_end) {
            return this.setState({
              selection_end: null
            });
          } else if (this.state.cursor > 0) {
            return this.setState({
              cursor: this.state.cursor - 1
            });
          }
        }
      } else if (event.keyCode === KEYCODES.right) {
        if (event.shiftKey) {
          selection_end = this.state.selection_end || this.state.cursor;
          if (selection_end < this.state.text.length) {
            return this.setState({
              selection_end: selection_end + 1
            });
          }
        } else {
          if (this.state.selection_end) {
            return this.setState({
              cursor: this.state.selection_end,
              selection_end: null
            });
          } else if (this.state.cursor < this.state.text.length) {
            return this.setState({
              cursor: this.state.cursor + 1
            });
          }
        }
      }
    },
    onPaste: function(event) {
      var characters, data;
      data = event.clipboardData;
      characters = data.getData(data.types[0]);
      return console.log("insert characters", characters, this.state.cursor, this.state.selection_end);
    },
    render: function() {
      var children, tree;
      tree = overlayedTextToTree(this.state.overlays, this.state.text, this.state.cursor);
      children = this.renderTreeList(tree.children);
      return React.createElement('div', {
        'data-start-index': 0,
        'data-end-index': this.state.text.length,
        onClick: this.onClick,
        onKeyPress: this.onKeypress,
        onKeyDown: this.onKeyDown,
        onPaste: this.onPaste,
        tabIndex: 1
      }, children);
    }
  });

  KEYCODES = {
    left: 37,
    up: 38,
    right: 39,
    down: 40,
    backspace: 8
  };

  top = function(stack) {
    return stack[stack.length - 1];
  };

  window.gapi.load('auth:client,drive-realtime,drive-share', function() {
    var doc;
    doc = gapi.drive.realtime.newInMemoryDocument();
    return React.render(React.createElement(Editor, {
      "doc": doc
    }), document.getElementById('main'));
  });

}).call(this);
